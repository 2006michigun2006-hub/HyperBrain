<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMind | Final Project</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <header>
        <div class="flex-gap" style="align-items: center;">
            <span style="font-size: 1.5rem;"></span>
            <h1 style="margin:0; font-size: 1.2rem;">HyperBrain</h1>
        </div>
        <div id="user-info" class="hidden flex-gap">
            <button onclick="showDashboard()" class="btn-outline btn-small">Home</button>
            <button onclick="showProfile()" class="btn-outline btn-small">Profile</button>
            <button onclick="logout()" class="btn-danger btn-small">Logout</button>
        </div>
    </header>
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2 id="auth-title">Login</h2>
            <form id="auth-form" onsubmit="handleAuth(event)">
                <input type="text" id="auth-username" placeholder="Username" required>
                <input type="email" id="auth-email" placeholder="Email (only for register)" class="hidden">
                <input type="password" id="auth-password" placeholder="Password" required>
                <button type="submit" id="auth-btn">Login</button>
            </form>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                <span id="auth-switch-text">No account? </span>
                <a href="#" onclick="toggleAuthMode()" style="color: var(--accent);">Click here!</a>
            </p>
        </div>
    </div>
    <div id="dashboard-section" class="hidden">
        <div class="flex-between" style="margin-bottom: 1.5rem;">
            <input type="text" id="search-input" placeholder="Search for quizzes! Its free!" oninput="searchQuizzes()" style="margin:0; max-width: 300px;">
            <button onclick="showCreateQuiz()">+ Create Quiz</button>
        </div>
        <div id="quiz-list" class="quiz-grid">
            </div>
    </div>
    <div id="profile-section" class="hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;"> <img id="profile-avatar" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; background: #334155; margin-bottom: 15px; border: 3px solid var(--accent);">
            <h2>User Profile</h2>
            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-secondary);">Your score:</p>
                <h1 id="profile-score" style="color: var(--success);">0</h1>
            </div>
            <form onsubmit="updateProfile(event)">
                <label>Username</label>
                <input type="text" id="profile-username">
                <label>Email</label>
                <input type="text" id="profile-email">
                <button type="submit">Update Profile</button>
            </form>
        </div>
    </div>
    <div id="create-section" class="hidden">
        <div class="card">
            <div class="flex-between">
                <h2>Create new Quiz</h2>
                <button onclick="showDashboard()" class="btn-outline btn-small">Cancel</button>
            </div>
            <input type="text" id="new-quiz-title" placeholder="Quiz Title">
            <div id="questions-container"></div>
            <button onclick="addQuestionField()" class="btn-outline" style="width:100%; margin-bottom:1rem;">+ Add Question</button>
            <button onclick="submitNewQuiz()" style="width:100%;">Save Quiz</button>
        </div>
    </div>
    <div id="game-section" class="hidden">
        <div class="card" style="text-align: center;">
            <h2 id="game-title">Quiz title</h2>
            <div id="game-area" style="margin: 2rem 0;">
                <h3 id="question-text">Question goes here!</h3>
                <div id="options-area" class="quiz-grid"></div>
            </div>
            <p id="game-status"></p>
            <button onclick="showDashboard()" id="game-back-btn" class="hidden btn-outline">Back to main page!</button>
        </div>
    </div>
</div>
<script>
    const API_URL = 'https://hyperbrain.onrender.com/api';
    let isLoginMode = true;
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    let currentScore = 0;
    function checkAuth() {
        const token = localStorage.getItem('token');
        if(token) {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            showDashboard();
        } else {
            document.getElementById('auth-modal').classList.remove('hidden');
        }
    }
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? 'Login' : 'Register';
        document.getElementById('auth-btn').innerText = isLoginMode ? 'Login' : 'Register';
        document.getElementById('auth-email').classList.toggle('hidden');
        document.getElementById('auth-switch-text').innerText = isLoginMode ? 'No account? ' : 'Have an account? ';
    }
    async function handleAuth(e) {
        e.preventDefault();
        const username = document.getElementById('auth-username').value;
        const password = document.getElementById('auth-password').value;
        const email = document.getElementById('auth-email').value;
        const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
        const body = isLoginMode ? { username, password } : { username, email, password };
        try {
            const res = await fetch(API_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if(res.ok) {
                if(isLoginMode) {
                    localStorage.setItem('token', data.token);
                    checkAuth();
                } else {
                    alert('Registration successful! Please login.');
                    toggleAuthMode();
                }
            } else {
                alert(data.message);
            }
        } catch(err) { 
            alert('Error connecting to server'); 
        }
    }
    function logout() {
        localStorage.removeItem('token');
        location.reload();
    }
    function getToken() { return localStorage.getItem('token'); }
    function hideAllSections() {
        ['dashboard-section', 'profile-section', 'create-section', 'game-section'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
    }
    function showDashboard() {
        hideAllSections();
        document.getElementById('dashboard-section').classList.remove('hidden');
        fetchQuizzes();
    }
    async function showProfile() {
        hideAllSections();
        document.getElementById('profile-section').classList.remove('hidden');
        const res = await fetch(`${API_URL}/users/profile`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const user = await res.json();
        document.getElementById('profile-avatar').src = `https://api.dicebear.com/7.x/bottts/svg?seed=${user.username}`;
        document.getElementById('profile-username').value = user.username;
        document.getElementById('profile-email').value = user.email;
        document.getElementById('profile-score').innerText = user.count;
    }
    async function updateProfile(e) {
        e.preventDefault();
        const username = document.getElementById('profile-username').value;
        const email = document.getElementById('profile-email').value;
        const res = await fetch(`${API_URL}/users/profile`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}` 
            },
            body: JSON.stringify({ username, email })
        });
        if(res.ok) {
            alert('Profile updated!');
        }
    }
    async function fetchQuizzes(search = '') {
        const res = await fetch(`${API_URL}/quizzes?search=${search}`);
        const quizzes = await res.json();
        const list = document.getElementById('quiz-list');
        list.innerHTML = '';
        quizzes.forEach(quiz => {
            const div = document.createElement('div');
            div.className = 'card quiz-card';
            div.innerHTML = `
                <h3>${quiz.title}</h3>
                <p style="color:var(--text-secondary)">By ${quiz.creatorName || 'Unknown'}</p>
                <div class="flex-between">
                    <button onclick="playQuiz('${quiz._id}')" class="btn-small">Play</button>
                    ${quiz.creator === parseJwt(getToken()).id ? 
                        `<button onclick="deleteQuiz('${quiz._id}')" class="btn-danger btn-small">Delete</button>` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }
    function searchQuizzes() {
        const query = document.getElementById('search-input').value;
        fetchQuizzes(query);
    }
    async function deleteQuiz(id) {
        if(!confirm('Are you sure?')) {
            return;
        }
        await fetch(`${API_URL}/quizzes/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        fetchQuizzes();
    }
    let questionsTemp = [];
    function showCreateQuiz() {
        hideAllSections();
        document.getElementById('create-section').classList.remove('hidden');
        questionsTemp = [];
        document.getElementById('new-quiz-title').value = '';
        renderQuestionsForm();
    }
    function addQuestionField() {
        questionsTemp.push({ questionText: '', options: ['', '', ''], correctAnswer: 0 });
        renderQuestionsForm();
    }
    function renderQuestionsForm() {
        const container = document.getElementById('questions-container');
        container.innerHTML = questionsTemp.map((q, i) => `
            <div class="card" style="padding:1rem; border:1px solid #334155;">
                <input type="text" placeholder="Question Text" value="${q.questionText}" onchange="updateQ(${i}, 'text', this.value)">
                ${q.options.map((opt, oi) => `
                    <input type="text" placeholder="Option ${oi+1}" value="${opt}" onchange="updateQ(${i}, 'opt', this.value, ${oi})">
                `).join('')}
                <select onchange="updateQ(${i}, 'correct', this.value)">
                    ${q.options.map((_, oi) => `<option value="${oi}" ${q.correctAnswer == oi ? 'selected' : ''}>Correct: Option ${oi+1}</option>`).join('')}
                </select>
            </div>
        `).join('');
    }
    function updateQ(idx, type, val, optIdx) {
        if(type === 'text') {
            questionsTemp[idx].questionText = val;
        }
        if(type === 'opt') {
            questionsTemp[idx].options[optIdx] = val;
        }
        if(type === 'correct') {
            questionsTemp[idx].correctAnswer = parseInt(val);
        }
    }
    async function submitNewQuiz() {
        const title = document.getElementById('new-quiz-title').value;
        if(!title || questionsTemp.length === 0) {
            return alert('Fill all fields!');
        }
        const res = await fetch(`${API_URL}/quizzes`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${getToken()}` 
            },
            body: JSON.stringify({ title, questions: questionsTemp })
        });
        if(res.ok) {
            alert('Quiz Created!');
            showDashboard();
        } else {
            const d = await res.json();
            alert(d.message);
        }
    }
    async function playQuiz(id) {
        const res = await fetch(`${API_URL}/quizzes/${id}`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        currentQuiz = await res.json();
        currentQuestionIndex = 0;
        currentScore = 0;
        hideAllSections();
        document.getElementById('game-section').classList.remove('hidden');
        document.getElementById('game-back-btn').classList.add('hidden');
        document.getElementById('game-title').innerText = currentQuiz.title;
        renderGameQuestion();
    }
    function renderGameQuestion() {
        if(currentQuestionIndex >= currentQuiz.questions.length) {
            finishGame();
            return;
        }
        const q = currentQuiz.questions[currentQuestionIndex];
        document.getElementById('question-text').innerText = q.questionText;
        document.getElementById('game-status').innerText = `Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}`;
        const optsDiv = document.getElementById('options-area');
        optsDiv.innerHTML = q.options.map((opt, i) => `
            <button onclick="handleAnswer(${i})" class="btn-outline" style="width:100%">${opt}</button>
        `).join('');
    }
    function handleAnswer(selectedIndex) {
        const q = currentQuiz.questions[currentQuestionIndex];
        if(selectedIndex === q.correctAnswer) {
            currentScore += 10;
            alert("Correct! +10 points");
        } else {
            alert("Wrong!");
        }
        currentQuestionIndex++;
        renderGameQuestion();
    }
    async function finishGame() {
        document.getElementById('question-text').innerText = "Game Over!";
        document.getElementById('options-area').innerHTML = "";
        document.getElementById('game-status').innerText = `Total Score: ${currentScore}`;
        document.getElementById('game-back-btn').classList.remove('hidden');
        if(currentScore > 0) {
            await fetch(`${API_URL}/quizzes/score`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({ points: currentScore })
            });
        }
    }
    function parseJwt (token) {
        try { 
            return JSON.parse(atob(token.split('.')[1])); 
        } catch(e) { 
            return null; 
        }
    }
    checkAuth();
</script>
</body>

</html>
